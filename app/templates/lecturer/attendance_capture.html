{% extends "base.html" %}

{% block title %}Pengambilan Absensi - {{ session.session_name }}{% endblock %}

{% block extra_css %}
<link href="{{ url_for('static', filename='css/face_capture.css') }}" rel="stylesheet">
<style>
    #video-container {
        position: relative;
        max-width: 100%;
        background: #000;
        border-radius: 10px;
        overflow: hidden;
    }

    #video {
        width: 100%;
        height: auto;
        display: block;
    }

    #face-detection {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
    }

    .detection-box {
        position: absolute;
        border: 2px solid #00ff00;
        box-shadow: 0 0 10px rgba(0, 255, 0, 0.5);
    }

    .attendance-list {
        max-height: 400px;
        overflow-y: auto;
    }

    .student-item {
        padding: 10px;
        border-bottom: 1px solid #ddd;
        animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateX(-20px);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    .status-badge {
        font-weight: bold;
        padding: 5px 10px;
        border-radius: 20px;
    }

    .face-verification {
        background: #f8f9fa;
        border: 2px dashed #ccc;
        border-radius: 10px;
        padding: 20px;
        text-align: center;
        min-height: 150px;
        margin-bottom: 20px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
    }

    .face-verification.confirmed {
        border: 2px solid #28a745;
        background: #f0fff4;
    }

    .face-verification.unverified {
        border: 2px solid #ffc107;
        background: #fff3cd;
    }

    .face-verification.error {
        border: 2px solid #dc3545;
        background: #f8d7da;
    }

    .verification-steps {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
    }

    .step {
        padding: 10px;
        margin: 5px 0;
        border-radius: 5px;
        background: #f8f9fa;
    }

    .step.completed {
        background: #d4edda;
        color: #155724;
    }

    .step.active {
        background: #cce5ff;
        color: #004085;
        font-weight: bold;
    }

    .btn-attendance {
        padding: 10px 20px;
        font-weight: bold;
        border-radius: 5px;
        margin: 5px;
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-3">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2 class="h4">
                    <i class="fas fa-camera"></i> Pengambilan Absensi
                </h2>
                <p class="text-muted">{{ class_obj.name }} ({{ class_obj.code }})</p>
            </div>
            <div>
                {% if session.is_active %}
                    <span class="status-badge bg-success text-white">
                        <i class="fas fa-circle"></i> Sesi Aktif
                    </span>
                {% else %}
                    <span class="status-badge bg-danger text-white">
                        <i class="fas fa-circle"></i> Sesi Ditutup
                    </span>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Video & Controls Area -->
    <div class="col-lg-8">
        <div class="card shadow-sm mb-3">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-video"></i> Absensi Wajah Manual</h5>
            </div>
            <div class="card-body">
                <div id="video-container">
                    <video id="video" playsinline autoplay muted width="100%"></video>
                </div>
                
                <!-- Verification Box -->
                <div id="verificationBox" class="face-verification unverified mt-3">
                    <h5><i class="fas fa-user"></i> Tampilkan Wajah di Kamera</h5>
                    <p class="text-muted" id="verificationStatus">Menunggu pengambilan wajah...</p>
                </div>
                
                <!-- Action Buttons -->
                <div class="row mt-3">
                    <div class="col-md-6">
                        <button id="captureBtn" class="btn btn-primary btn-attendance w-100">
                            <i class="fas fa-camera"></i> Ambil Wajah
                        </button>
                    </div>
                    <div class="col-md-6">
                        <button id="confirmBtn" class="btn btn-success btn-attendance w-100" disabled>
                            <i class="fas fa-check"></i> Konfirmasi Hadir
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Session Controls -->
        <div class="card shadow-sm">
            <div class="card-body">
                <div class="row">
                    <div class="col-12 mb-2">
                        {% if session.is_active %}
                            <button id="endSessionBtn" class="btn btn-danger btn-attendance w-100">
                                <i class="fas fa-stop"></i> Akhiri Sesi Absensi
                            </button>
                        {% else %}
                            <button class="btn btn-secondary btn-attendance w-100" disabled>
                                <i class="fas fa-check"></i> Sesi Telah Ditutup
                            </button>
                        {% endif %}
                    </div>
                    <div class="col-6">
                        <button id="downloadReportBtn" class="btn btn-info btn-attendance w-100">
                            <i class="fas fa-download"></i> Download CSV
                        </button>
                    </div>
                    <div class="col-6">
                        <a href="{{ url_for('lecturer.class_detail', class_id=class_obj.id) }}"
                           class="btn btn-secondary btn-attendance w-100">
                            <i class="fas fa-arrow-left"></i> Kembali
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Attendance List -->
    <div class="col-lg-4">
        <div class="card shadow-sm">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <i class="fas fa-check-circle"></i> Kehadiran
                    <span class="badge bg-light text-dark float-end" id="attendance-badge">0</span>
                </h5>
            </div>
            <div class="card-body attendance-list" id="attendanceList">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> Menunggu konfirmasi kehadiran...
                </div>
            </div>
        </div>
        
        <!-- Verification Steps -->
        <div class="verification-steps mt-3">
            <h6><i class="fas fa-info-circle"></i> Alur Absensi:</h6>
            <div class="step active" id="step1">
                1. Mahasiswa tampilkan wajah di kamera
            </div>
            <div class="step" id="step2">
                2. Klik tombol "Ambil Wajah"
            </div>
            <div class="step" id="step3">
                3. Sistem verifikasi identitas
            </div>
            <div class="step" id="step4">
                4. Klik "Konfirmasi Hadir"
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
<script>
const SESSION_ID = {{ session.id }};
const CLASS_ID = {{ class_obj.id }};
const STUDENTS = {{ students|tojson }};

let attendedStudents = new Set();
let videoElement;
let currentMatchedStudent = null;
let currentConfidence = 0;

async function initWebcam() {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({
            video: {
                width: { ideal: 1280 },
                height: { ideal: 720 },
                facingMode: 'user'
            }
        });

        videoElement = document.getElementById('video');
        videoElement.srcObject = stream;

        // Load face-api models
        const MODEL_URL = 'https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1.7.13/model/';
        await Promise.all([
            faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
            faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
            faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL),
            faceapi.nets.faceExpressionNet.loadFromUri(MODEL_URL),
            faceapi.nets.ageGenderNet.loadFromUri(MODEL_URL)
        ]);

        console.log('✓ Face API models loaded');
        
        // Update status
        document.getElementById('verificationStatus').innerHTML = `
            <div class="text-center">
                <h5><i class="fas fa-user text-primary"></i> Tampilkan Wajah di Kamera</h5>
                <p class="text-muted mb-0">Pastikan wajah terlihat jelas dan pencahayaan cukup</p>
            </div>
        `;
    } catch (error) {
        console.error('✗ Webcam error:', error);
        document.getElementById('verificationStatus').innerHTML = `
            <div class="text-center">
                <h5><i class="fas fa-exclamation-triangle text-danger"></i> Gagal Mengakses Kamera</h5>
                <p class="text-muted mb-0">Harap izinkan akses kamera dan coba lagi</p>
                <button class="btn btn-sm btn-outline-primary mt-2" onclick="location.reload()">Muat Ulang</button>
            </div>
        `;
        document.getElementById('verificationBox').className = 'face-verification error mt-3';
    }
}

let isProcessing = false; // Variable to prevent multiple clicks

async function captureFace() {
    if (isProcessing) return; // Prevent multiple clicks if already processing
    
    isProcessing = true;
    document.getElementById('captureBtn').disabled = true;
    document.getElementById('captureBtn').innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Memproses...';
    document.getElementById('verificationStatus').innerHTML = `
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Memproses...</span>
            </div>
            <div class="mt-2">Mendeteksi wajah...</div>
        </div>
    `;
    document.getElementById('verificationBox').className = 'face-verification unverified mt-3';

    try {
        // Check if video is playing
        if (!videoElement.srcObject) {
            throw new Error('Kamera tidak aktif. Harap refresh halaman.');
        }

        // Capture current frame
        const canvas = document.createElement('canvas');
        canvas.width = videoElement.videoWidth;
        canvas.height = videoElement.videoHeight;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(videoElement, 0, 0);
        const imageData = canvas.toDataURL('image/jpeg');

        // Send to server for face recognition
        const response = await fetch('{{ url_for("attendance.capture_single_face") }}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                session_id: SESSION_ID,
                image_data: imageData
            })
        });

        const result = await response.json();

        if (response.ok) {
            if (result.status === 'match') {
                currentMatchedStudent = result.student;
                currentConfidence = parseFloat(result.confidence);

                // Show success
                document.getElementById('verificationStatus').innerHTML = `
                    <div class="text-center">
                        <h5><i class="fas fa-check-circle text-success"></i> Wajah Dikenali!</h5>
                        <p class="mb-0"><strong>${result.student.name}</strong></p>
                        <p class="mb-0 text-muted">${result.student.student_id}</p>
                        <p class="mb-0">Confidence: ${result.confidence}</p>
                        ${result.already_recorded ?
                            '<span class="badge bg-warning">Sudah Absen</span>' :
                            '<span class="badge bg-success">Belum Absen</span>'
                        }
                    </div>
                `;
                document.getElementById('verificationBox').className = 'face-verification confirmed mt-3';

                // Enable confirmation button if not already recorded
                if (!result.already_recorded) {
                    document.getElementById('confirmBtn').disabled = false;
                    document.getElementById('confirmBtn').innerHTML = '<i class="fas fa-check"></i> Konfirmasi Hadir';
                } else {
                    document.getElementById('confirmBtn').disabled = true;
                    document.getElementById('confirmBtn').innerHTML = '<i class="fas fa-check"></i> Sudah Absen';
                }

                // Update step indicators
                document.getElementById('step2').className = 'step completed';
                document.getElementById('step3').className = 'step completed';
                document.getElementById('step4').className = 'step active';
            } else {
                // Show error
                let message = result.message || 'Wajah tidak dikenal';
                document.getElementById('verificationStatus').innerHTML = `
                    <div class="text-center">
                        <h5><i class="fas fa-exclamation-triangle text-danger"></i> ${message}</h5>
                        <p class="mb-0">Pastikan wajah terlihat jelas dan sesuai dengan data mahasiswa</p>
                    </div>
                `;
                document.getElementById('verificationBox').className = 'face-verification error mt-3';

                document.getElementById('confirmBtn').disabled = true;
                currentMatchedStudent = null;
                currentConfidence = 0;

                // Reset step indicators
                document.getElementById('step1').className = 'step active';
                document.getElementById('step2').className = 'step';
                document.getElementById('step3').className = 'step';
                document.getElementById('step4').className = 'step';
            }
        } else {
            // Handle server error
            document.getElementById('verificationStatus').innerHTML = `
                <div class="text-center">
                    <h5><i class="fas fa-exclamation-triangle text-danger"></i> Server Error</h5>
                    <p class="mb-0">Tidak dapat memproses permintaan. Silakan coba lagi.</p>
                </div>
            `;
            document.getElementById('verificationBox').className = 'face-verification error mt-3';
            document.getElementById('confirmBtn').disabled = true;
        }
    } catch (error) {
        console.error('Error capturing face:', error);
        document.getElementById('verificationStatus').innerHTML = `
            <div class="text-center">
                <h5><i class="fas fa-exclamation-triangle text-danger"></i> Error!</h5>
                <p class="mb-0">${error.message}</p>
            </div>
        `;
        document.getElementById('verificationBox').className = 'face-verification error mt-3';
        document.getElementById('confirmBtn').disabled = true;
    } finally {
        // Reset button state
        isProcessing = false;
        document.getElementById('captureBtn').disabled = false;
        document.getElementById('captureBtn').innerHTML = '<i class="fas fa-camera"></i> Ambil Wajah';
        
        // Disable confirm button if no match
        if (!currentMatchedStudent) {
            document.getElementById('confirmBtn').disabled = true;
            document.getElementById('confirmBtn').innerHTML = '<i class="fas fa-check"></i> Konfirmasi Hadir';
        }
    }
}

async function confirmAttendance() {
    if (!currentMatchedStudent || isProcessing) {
        if (!currentMatchedStudent) {
            alert('Tidak ada wajah yang dikenali!');
        }
        return;
    }

    isProcessing = true;
    document.getElementById('confirmBtn').disabled = true;
    document.getElementById('confirmBtn').innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Memproses...';

    try {
        // Record attendance
        const response = await fetch('{{ url_for("attendance.record_attendance") }}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                session_id: SESSION_ID,
                student_id: currentMatchedStudent.id,
                confidence_score: currentConfidence
            })
        });

        const result = await response.json();

        if (response.ok) {
            if (result.already_recorded) {
                alert(result.message);
            } else {
                alert(result.message);

                // Add to attendance list
                addAttendanceRecord(currentMatchedStudent);
                updateAttendanceBadge();

                // Show success state
                document.getElementById('verificationStatus').innerHTML = `
                    <div class="text-center">
                        <h5><i class="fas fa-check-circle text-success"></i> Hadir Dicatat!</h5>
                        <p class="mb-0"><strong>${currentMatchedStudent.name}</strong></p>
                        <p class="mb-0 text-muted">${currentMatchedStudent.student_id}</p>
                        <span class="badge bg-success">Telah Absen</span>
                    </div>
                `;
                document.getElementById('verificationBox').className = 'face-verification confirmed mt-3';
                document.getElementById('confirmBtn').disabled = true;
                document.getElementById('confirmBtn').innerHTML = '<i class="fas fa-check"></i> Sudah Absen';

                // Reset for next student
                currentMatchedStudent = null;
                currentConfidence = 0;
            }

            // Reset step indicators
            document.getElementById('step1').className = 'step active';
            document.getElementById('step2').className = 'step';
            document.getElementById('step3').className = 'step';
            document.getElementById('step4').className = 'step';
        } else {
            alert('Error: ' + (result.error || 'Gagal mencatat kehadiran'));
            document.getElementById('confirmBtn').disabled = false;
            document.getElementById('confirmBtn').innerHTML = '<i class="fas fa-check"></i> Konfirmasi Hadir';
        }
    } catch (error) {
        console.error('Error confirming attendance:', error);
        alert('Error: ' + error.message);
        document.getElementById('confirmBtn').disabled = false;
        document.getElementById('confirmBtn').innerHTML = '<i class="fas fa-check"></i> Konfirmasi Hadir';
    } finally {
        isProcessing = false;
    }
}

function addAttendanceRecord(student) {
    const listElement = document.getElementById('attendanceList');

    // Clear empty message jika ada
    const emptyAlert = listElement.querySelector('.alert-info');
    if (emptyAlert) {
        emptyAlert.remove();
    }

    const html = `
        <div class="student-item">
            <div class="d-flex justify-content-between">
                <div>
                    <strong>${student.name}</strong><br>
                    <small class="text-muted">${student.student_id}</small>
                </div>
                <div class="text-success">
                    <i class="fas fa-check"></i> ${new Date().toLocaleTimeString('id-ID')}
                </div>
            </div>
        </div>
    `;

    listElement.insertAdjacentHTML('afterbegin', html);
}

function updateAttendanceBadge() {
    // We need to make an API call to get the actual count
    // For now, we'll just count the list items
    const listElement = document.getElementById('attendanceList');
    const count = listElement.querySelectorAll('.student-item').length;
    document.getElementById('attendance-badge').textContent = count;
}

document.getElementById('captureBtn').addEventListener('click', captureFace);
document.getElementById('confirmBtn').addEventListener('click', confirmAttendance);

document.getElementById('endSessionBtn').addEventListener('click', async () => {
    if (!confirm('Akhiri sesi absensi?')) return;

    try {
        const response = await fetch(`{{ url_for('attendance.end_session', session_id=session.id) }}`, {
            method: 'POST'
        });

        if (response.ok) {
            alert('Sesi absensi ditutup');
            location.reload();
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
});

document.getElementById('downloadReportBtn').addEventListener('click', () => {
    location.href = `{{ url_for('report.download_session_csv', session_id=session.id) }}`;
});

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    initWebcam();
});

// Cleanup
window.addEventListener('beforeunload', () => {
    if (videoElement && videoElement.srcObject) {
        videoElement.srcObject.getTracks().forEach(track => track.stop());
    }
});
</script>
{% endblock %}
